<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Centro de Estudios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #F8F7F4; --foreground: #FFFFFF; --card: #FFFFFF; --text-primary: #333333; --text-secondary: #6B7280; --border: #E5E7EB; --primary: #2563EB; --primary-foreground: #FFFFFF; --accent: #E9E8E5; --danger: #EF4444;
        }
        [data-theme="dark"] {
            --background: #111827; --foreground: #1F2937; --card: #1F2937; --text-primary: #F9FAFB; --text-secondary: #9CA3AF; --border: #374151; --primary: #3B82F6; --primary-foreground: #FFFFFF; --accent: #374151; --danger: #F87171;
        }
        [data-theme="ocean"] {
            --background: #EFF6FF; --foreground: #FFFFFF; --card: #FFFFFF; --text-primary: #1E3A8A; --text-secondary: #3B82F6; --border: #BFDBFE; --primary: #1D4ED8; --primary-foreground: #FFFFFF; --accent: #DBEAFE; --danger: #FB7185;
        }
        [data-theme="forest"] {
            --background: #F0FFF4; --foreground: #FFFFFF; --card: #FFFFFF; --text-primary: #14532D; --text-secondary: #16A34A; --border: #BBF7D0; --primary: #15803D; --primary-foreground: #FFFFFF; --accent: #D1FAE5; --danger: #FB7185;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text-primary); }
        .nav-item { transition: all 0.2s ease-in-out; }
        .nav-item.active, .nav-item:hover { background-color: var(--accent); color: var(--primary); }
        .task-item.completed { text-decoration: line-through; opacity: 0.6; }
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day.has-event { background-color: var(--accent); font-weight: bold; color: var(--primary); position: relative; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; background-color: var(--primary); }
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .chart-container { position: relative; width: 100%; height: 450px; max-height: 60vh; }
        .priority-badge { font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 9999px; text-transform: uppercase; }
        .priority-1 { background-color: #D1FAE5; color: #065F46; } .priority-2 { background-color: #DBEAFE; color: #1E40AF; } .priority-3 { background-color: #FEF3C7; color: #92400E; } .priority-4 { background-color: #FEE2E2; color: #991B1B; } .priority-5 { background-color: #E11D48; color: #FFFFFF; }
        .emotion-btn { transition: transform 0.2s; }
        .emotion-btn:hover { transform: scale(1.1); }
        .emotion-btn.selected { outline: 2px solid var(--primary); box-shadow: 0 0 10px rgba(var(--primary), 0.5); transform: scale(1.1); }
        .control-btn.active { background-color: var(--primary); color: var(--primary-foreground); }
    </style>
    <!-- Chosen Palette: Calm Neutrals -->
    <!-- Application Structure Plan: SPA con navegaci√≥n por pesta√±as. Se mantiene la estructura modular. La secci√≥n "An√°lisis" se redise√±a por completo para alojar un √∫nico y potente gr√°fico de correlaci√≥n interactivo, convirti√©ndose en el n√∫cleo anal√≠tico de la aplicaci√≥n. -->
    <!-- Visualization & Content Choices: 1. An√°lisis: Se reemplazan los gr√°ficos anteriores por un √∫nico gr√°fico combinado (Chart.js). Utiliza un eje de tiempo (X), un eje para emociones (Y-izquierda) y otro para calificaciones (Y-derecha). Las emociones son l√≠neas, las calificaciones son puntos y los eventos importantes son √≠conos (puntos de tipo 'scatter' con 'pointStyle'). Se a√±aden filtros interactivos para controlar la visibilidad de los datos, mejorando dr√°sticamente la capacidad del usuario para descubrir insights. Se a√±ade timestamp a las calificaciones para poder ubicarlas en el tiempo. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="flex flex-col md:flex-row h-screen bg-[var(--background)] text-[var(--text-primary)]">

    <nav class="w-full md:w-64 bg-[var(--foreground)] border-b md:border-r border-[var(--border)] flex-shrink-0">
        <div class="flex items-center justify-between p-4 h-16">
            <h1 class="text-xl font-bold text-[var(--primary)]">EstudioPro</h1>
            <button id="mobile-menu-button" class="md:hidden p-2 rounded-md hover:bg-[var(--accent)]"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
        </div>
        <div id="nav-menu" class="hidden md:flex flex-col justify-between h-full md:h-auto pb-4 md:pb-0">
            <div class="p-2 space-y-1">
                <a href="#" data-section="panel" class="nav-item active flex items-center gap-3 p-3 rounded-lg font-medium"><span>üìä</span> Panel</a>
                <a href="#" data-section="tareas" class="nav-item flex items-center gap-3 p-3 rounded-lg font-medium"><span>üìù</span> Tareas</a>
                <a href="#" data-section="calendario" class="nav-item flex items-center gap-3 p-3 rounded-lg font-medium"><span>üìÖ</span> Calendario</a>
                <a href="#" data-section="calificaciones" class="nav-item flex items-center gap-3 p-3 rounded-lg font-medium"><span>üéì</span> Calificaciones</a>
                <a href="#" data-section="social" class="nav-item flex items-center gap-3 p-3 rounded-lg font-medium"><span>üßë‚Äçü§ù‚Äçüßë</span> Bienestar Social</a>
                <a href="#" data-section="analisis" class="nav-item flex items-center gap-3 p-3 rounded-lg font-medium"><span>üìà</span> An√°lisis</a>
            </div>
            <div class="p-4 mt-auto">
                <h4 class="text-sm font-semibold text-[var(--text-secondary)] mb-2">Temas</h4>
                <div class="flex justify-around">
                    <button class="theme-btn h-8 w-8 rounded-full bg-[#F8F7F4] border-2 border-[var(--border)]" data-theme="light"></button>
                    <button class="theme-btn h-8 w-8 rounded-full bg-[#111827] border-2 border-[var(--border)]" data-theme="dark"></button>
                    <button class="theme-btn h-8 w-8 rounded-full bg-[#EFF6FF] border-2 border-[var(--border)]" data-theme="ocean"></button>
                    <button class="theme-btn h-8 w-8 rounded-full bg-[#F0FFF4] border-2 border-[var(--border)]" data-theme="forest"></button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
        <!-- Panel Principal (se mantiene igual) -->
        <section id="panel" class="content-section">
            <h2 class="text-3xl font-bold mb-6">Panel Principal</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)]">
                        <h3 class="text-xl font-semibold mb-4">¬øC√≥mo te sientes hoy? (General)</h3>
                        <div id="emotion-tracker" class="flex justify-around items-center mb-4">
                            <button class="emotion-btn text-4xl" data-emotion="Feliz" title="Feliz">üòä</button>
                            <button class="emotion-btn text-4xl" data-emotion="Concentrado" title="Concentrado">ü§ì</button>
                            <button class="emotion-btn text-4xl" data-emotion="Cansado" title="Cansado">üò¥</button>
                            <button class="emotion-btn text-4xl" data-emotion="Estresado" title="Estresado">üò´</button>
                            <button class="emotion-btn text-4xl" data-emotion="Triste" title="Triste">üò¢</button>
                        </div>
                        <input type="text" id="emotion-note" class="w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]" placeholder="A√±ade una nota (opcional)...">
                        <button id="save-emotion-btn" class="w-full mt-3 bg-[var(--primary)] text-[var(--primary-foreground)] font-bold py-2 px-4 rounded-lg hover:opacity-90 transition">Guardar Emoci√≥n</button>
                    </div>
                     <div class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)]">
                        <h3 class="text-xl font-semibold mb-4">Tareas Pr√≥ximas</h3>
                        <div id="upcoming-tasks-list" class="space-y-3"></div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)]">
                        <h3 class="text-xl font-semibold mb-4">Pr√≥ximos Eventos</h3>
                        <div id="upcoming-events-list" class="space-y-3"></div>
                    </div>
                    <div class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)]">
                        <h3 class="text-xl font-semibold mb-2">Promedio General</h3>
                        <p id="general-average" class="text-4xl font-bold text-[var(--primary)]"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Otras secciones (Tareas, Calendario, etc. se mantienen igual) -->
        <section id="tareas" class="content-section hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div><h2 class="text-3xl font-bold">Gestor de Tareas</h2><p class="text-md text-[var(--text-secondary)] mt-1 max-w-2xl">Organiza tus tareas, asigna prioridades y mantente al d√≠a con tus responsabilidades acad√©micas.</p></div>
                <button id="add-task-btn" class="bg-[var(--primary)] text-[var(--primary-foreground)] font-bold py-2 px-4 rounded-lg hover:opacity-90 transition w-full sm:w-auto">A√±adir Tarea</button>
            </div>
            <div id="task-list" class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)]"></div>
        </section>
        <section id="calendario" class="content-section hidden">
             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div><h2 class="text-3xl font-bold">Calendario Acad√©mico</h2><p class="text-md text-[var(--text-secondary)] mt-1 max-w-2xl">Visualiza fechas importantes y planifica tu tiempo de manera efectiva.</p></div>
                <button id="add-event-btn" class="bg-[var(--primary)] text-[var(--primary-foreground)] font-bold py-2 px-4 rounded-lg hover:opacity-90 transition w-full sm:w-auto">A√±adir Evento</button>
            </div>
            <div class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)]">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-[var(--accent)]">‚óÄ</button>
                    <h3 id="month-year" class="text-xl font-semibold"></h3>
                    <button id="next-month" class="p-2 rounded-full hover:bg-[var(--accent)]">‚ñ∂</button>
                </div>
                <div class="grid calendar-grid font-semibold text-center text-[var(--text-secondary)] mb-2"><div>Do</div><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>S√°</div></div>
                <div id="calendar-body" class="grid calendar-grid gap-1"></div>
            </div>
        </section>
        <section id="calificaciones" class="content-section hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div><h2 class="text-3xl font-bold">Registro de Calificaciones</h2><p class="text-md text-[var(--text-secondary)] mt-1 max-w-2xl">Lleva un control detallado de tus notas por asignatura para visualizar tu rendimiento.</p></div>
                <button id="add-subject-btn" class="bg-[var(--primary)] text-[var(--primary-foreground)] font-bold py-2 px-4 rounded-lg hover:opacity-90 transition w-full sm:w-auto">A√±adir Asignatura</button>
            </div>
            <div id="subjects-container" class="space-y-4"></div>
        </section>
        <section id="social" class="content-section hidden">
            <h2 class="text-3xl font-bold mb-2">Bienestar Social</h2>
            <p class="text-md text-[var(--text-secondary)] mb-6 max-w-3xl">Lleva un registro de c√≥mo te sientes con respecto a una persona importante en tu vida.</p>
            <div class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)] mb-6">
                <h3 class="text-xl font-semibold mb-4">Persona a Registrar</h3>
                <div class="flex gap-4"><input type="text" id="person-name-input" class="flex-grow border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]" placeholder="Nombre..."><button id="save-person-name-btn" class="bg-[var(--primary)] text-[var(--primary-foreground)] font-bold py-2 px-4 rounded-lg hover:opacity-90">Guardar</button></div>
            </div>
            <div id="person-feeling-logger" class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)] mb-6">
                <h3 class="text-xl font-semibold mb-4">¬øC√≥mo te sientes sobre <span id="tracked-person-name" class="text-[var(--primary)]">...</span>?</h3>
                 <div id="person-emotion-tracker" class="flex justify-around items-center flex-wrap gap-4 mb-4">
                    <button class="emotion-btn text-4xl" data-emotion="Feliz" title="Feliz">üòä</button><button class="emotion-btn text-4xl" data-emotion="Agradecido" title="Agradecido">ü•∞</button><button class="emotion-btn text-4xl" data-emotion="Amado" title="Amado">üòç</button><button class="emotion-btn text-4xl" data-emotion="Confundido" title="Confundido">ü§î</button><button class="emotion-btn text-4xl" data-emotion="Enojado" title="Enojado">üò†</button><button class="emotion-btn text-4xl" data-emotion="Triste" title="Triste">üò¢</button>
                </div>
                <input type="text" id="person-emotion-note" class="w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]" placeholder="A√±ade una nota (opcional)...">
                <button id="save-person-emotion-btn" class="w-full mt-3 bg-[var(--primary)] text-[var(--primary-foreground)] font-bold py-2 px-4 rounded-lg hover:opacity-90">Guardar Sentimiento</button>
            </div>
            <div class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)]">
                 <h3 class="text-xl font-semibold mb-4">Historial de Sentimientos</h3>
                 <div id="person-feelings-history" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>
        </section>

        <!-- AN√ÅLISIS - Nueva secci√≥n -->
        <section id="analisis" class="content-section hidden">
            <h2 class="text-3xl font-bold mb-2">Panel de Correlaci√≥n</h2>
            <p class="text-md text-[var(--text-secondary)] mb-6 max-w-4xl">
                Visualiza la conexi√≥n entre tu estado de √°nimo, relaciones, eventos acad√©micos y calificaciones. Utiliza los filtros para explorar diferentes combinaciones y descubrir patrones en tu vida diaria.
            </p>

            <div class="bg-[var(--card)] p-6 rounded-xl shadow-sm border border-[var(--border)]">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <!-- Controles de Filtro -->
                    <div id="correlation-chart-toggles" class="flex flex-wrap gap-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-dataset="general" checked class="h-4 w-4 rounded"> √Ånimo General</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-dataset="social" checked class="h-4 w-4 rounded"> Sentimiento Social</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-dataset="grades" checked class="h-4 w-4 rounded"> Calificaciones</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-dataset="events" checked class="h-4 w-4 rounded"> Eventos Clave</label>
                    </div>
                    <!-- Controles de Rango de Tiempo -->
                    <div id="correlation-chart-ranges" class="flex-shrink-0">
                        <button data-range="7" class="control-btn border border-[var(--border)] px-3 py-1 rounded-md text-sm">7d</button>
                        <button data-range="30" class="control-btn active border border-[var(--border)] px-3 py-1 rounded-md text-sm">30d</button>
                        <button data-range="90" class="control-btn border border-[var(--border)] px-3 py-1 rounded-md text-sm">90d</button>
                        <button data-range="all" class="control-btn border border-[var(--border)] px-3 py-1 rounded-md text-sm">Todo</button>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="correlationChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Modals (se mantienen igual) -->
        <div id="task-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-[var(--card)] rounded-xl shadow-xl p-6 w-full max-w-md border border-[var(--border)]">
                <h3 id="task-modal-title" class="text-2xl font-bold mb-4"></h3>
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <div class="mb-4"><label for="task-name" class="block text-sm font-medium text-[var(--text-secondary)]">Nombre</label><input type="text" id="task-name" class="mt-1 block w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]" required></div>
                    <div class="mb-4"><label for="task-subject" class="block text-sm font-medium text-[var(--text-secondary)]">Asignatura</label><input type="text" id="task-subject" class="mt-1 block w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]" required></div>
                    <div class="mb-4"><label for="task-due-date" class="block text-sm font-medium text-[var(--text-secondary)]">Fecha</label><input type="date" id="task-due-date" class="mt-1 block w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]" required></div>
                    <div class="mb-4"><label for="task-priority" class="block text-sm font-medium text-[var(--text-secondary)]">Prioridad</label><select id="task-priority" class="mt-1 block w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]"><option value="5">5 - Muy Alta</option><option value="4">4 - Alta</option><option value="3" selected>3 - Media</option><option value="2">2 - Baja</option><option value="1">1 - Muy Baja</option></select></div>
                    <div class="flex justify-end gap-3 mt-6"><button type="button" id="cancel-task-btn" class="bg-transparent border border-[var(--border)] text-[var(--text-primary)] font-bold py-2 px-4 rounded-lg hover:bg-[var(--accent)]">Cancelar</button><button type="submit" class="bg-[var(--primary)] text-[var(--primary-foreground)] font-bold py-2 px-4 rounded-lg">Guardar</button></div>
                </form>
            </div>
        </div>
        <div id="event-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-[var(--card)] rounded-xl shadow-xl p-6 w-full max-w-md border border-[var(--border)]">
                <h3 class="text-2xl font-bold mb-4">A√±adir Evento</h3>
                <form id="event-form">
                    <div class="mb-4"><label for="event-title" class="block text-sm font-medium text-[var(--text-secondary)]">T√≠tulo</label><input type="text" id="event-title" class="mt-1 block w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]" required></div>
                    <div class="mb-4"><label for="event-date" class="block text-sm font-medium text-[var(--text-secondary)]">Fecha</label><input type="date" id="event-date" class="mt-1 block w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]" required></div>
                    <div class="mb-4"><label for="event-type" class="block text-sm font-medium text-[var(--text-secondary)]">Tipo</label><select id="event-type" class="mt-1 block w-full border border-[var(--border)] rounded-md py-2 px-3 bg-[var(--foreground)]"><option value="examen">Examen</option><option value="entrega">Entrega</option><option value="recordatorio">Recordatorio</option></select></div>
                    <div class="flex justify-end gap-3 mt-6"><button type="button" id="cancel-event-btn" class="bg-transparent border border-[var(--border)] text-[var(--text-primary)] font-bold py-2 px-4 rounded-lg hover:bg-[var(--accent)]">Cancelar</button><button type="submit" class="bg-[var(--primary)] text-[var(--primary-foreground)] font-bold py-2 px-4 rounded-lg">Guardar</button></div>
                </form>
            </div>
        </div>
        <div id="day-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-[var(--card)] rounded-xl shadow-xl p-6 w-full max-w-md border border-[var(--border)]">
                <div class="flex justify-between items-center mb-4"><h3 id="day-details-title" class="text-2xl font-bold"></h3><button id="close-day-details-btn" class="p-2 rounded-full hover:bg-[var(--accent)]">‚úñ</button></div>
                <div id="day-events-list" class="space-y-3"></div>
            </div>
        </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // State Management
    function saveState() { localStorage.setItem('studyHubState', JSON.stringify(state)); }
    function loadState() {
        const savedState = localStorage.getItem('studyHubState');
        if (savedState) {
            const loaded = JSON.parse(savedState);
            if (!loaded.emotions) loaded.emotions = [];
            if (!loaded.trackedPersonName) loaded.trackedPersonName = '';
            if (!loaded.personFeelings) loaded.personFeelings = [];
            if (loaded.subjects) {
                loaded.subjects.forEach(s => {
                    if (s.grades && !s.grades.every(g => g.timestamp)) {
                        s.grades.forEach(g => { if (!g.timestamp) g.timestamp = new Date().toISOString(); });
                    }
                });
            }
            return loaded;
        }
        const today = new Date(), tomorrow = new Date(today), nextWeek = new Date(today), yesterday = new Date(today);
        tomorrow.setDate(today.getDate() + 1); nextWeek.setDate(today.getDate() + 7); yesterday.setDate(today.getDate() - 1);
        const formatDate = (d) => d.toISOString().split('T')[0];
        return {
            tasks: [{ id: 1, name: 'Ensayo Final', subject: 'Historia', dueDate: formatDate(nextWeek), completed: false, priority: 4 }],
            events: [{ id: 1, title: 'Examen Parcial', date: formatDate(nextWeek), type: 'examen' }],
            subjects: [{ id: 1, name: 'Historia', grades: [{ id: 1, name: 'Examen 1', score: 85, timestamp: yesterday.toISOString() }] }],
            emotions: [{id: 1, emotion: 'Concentrado', note: 'Estudiando', timestamp: yesterday.toISOString()}],
            trackedPersonName: 'Alex',
            personFeelings: [{id: 1, feeling: 'Feliz', note: 'Salimos a cenar', timestamp: yesterday.toISOString()}]
        };
    }

    // Theme Management
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('studyHubTheme', theme);
        if (document.getElementById('analisis').classList.contains('hidden') === false) {
            renderCorrelationChart();
        }
    }

    let state = loadState();
    let currentDate = new Date();
    let correlationChartInstance;
    let selectedGeneralEmotion, selectedPersonEmotion;

    // UI Elements
    const sections = document.querySelectorAll('.content-section');
    const navItems = document.querySelectorAll('.nav-item');
    const taskModal = document.getElementById('task-modal');
    const taskForm = document.getElementById('task-form');
    const eventModal = document.getElementById('event-modal');
    const eventForm = document.getElementById('event-form');
    const dayDetailsModal = document.getElementById('day-details-modal');
    const navMenu = document.getElementById('nav-menu');

    // Navigation
    function showSection(sectionId) {
        sections.forEach(section => section.classList.toggle('hidden', section.id !== sectionId));
        navItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
        if (sectionId === 'analisis') {
            renderCorrelationChart(); 
        }
    }

    // Main Render Functions
    function renderAll() {
        renderDashboard();
        renderTasks();
        renderCalendar();
        renderSubjects();
        renderSocial();
    }

    // Component Renderers (Dashboard, Tasks, Calendar, Subjects, Social)
    function renderDashboard() {
        const upcomingTasksList = document.getElementById('upcoming-tasks-list');
        const upcomingEventsList = document.getElementById('upcoming-events-list');
        const generalAverageEl = document.getElementById('general-average');
        const today = new Date(); today.setHours(0,0,0,0);
        const upcomingTasks = state.tasks.filter(t => !t.completed && new Date(t.dueDate + 'T00:00:00') >= today).sort((a, b) => b.priority - a.priority || new Date(a.dueDate) - new Date(b.dueDate)).slice(0, 5);
        upcomingTasksList.innerHTML = upcomingTasks.length ? upcomingTasks.map(task => `<div class="flex items-center justify-between p-3 bg-[var(--accent)] rounded-lg"><div><p class="font-semibold">${task.name}</p><p class="text-sm text-[var(--text-secondary)]">${task.subject}</p></div><span class="priority-badge priority-${task.priority}">${task.priority}</span></div>`).join('') : `<p class="text-[var(--text-secondary)]">No tienes tareas pr√≥ximas.</p>`;
        const upcomingEvents = state.events.filter(e => new Date(e.date + 'T00:00:00') >= today).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
        upcomingEventsList.innerHTML = upcomingEvents.length ? upcomingEvents.map(event => `<div class="p-3 bg-[var(--accent)] rounded-lg"><p class="font-semibold">${event.title}</p><p class="text-sm text-[var(--text-secondary)]">${new Date(event.date + 'T00:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}</p></div>`).join('') : `<p class="text-[var(--text-secondary)]">No hay eventos pr√≥ximos.</p>`;
        let totalScore = 0, totalGrades = 0;
        state.subjects.forEach(s => s.grades.forEach(g => { totalScore += g.score; totalGrades++; }));
        generalAverageEl.textContent = totalGrades > 0 ? (totalScore / totalGrades).toFixed(2) : 'N/A';
    }
    function getPriorityText(p) { return { 5: 'Muy Alta', 4: 'Alta', 3: 'Media', 2: 'Baja', 1: 'Muy Baja' }[p] || ''; }
    function renderTasks() {
        const c = document.getElementById('task-list');
        if (!state.tasks.length) { c.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-8">No hay tareas.</p>'; return; }
        const sorted = [...state.tasks].sort((a, b) => a.completed - b.completed || b.priority - a.priority || new Date(a.dueDate) - new Date(b.dueDate));
        c.innerHTML = `<div class="space-y-4">${sorted.map(t => `<div class="task-item ${t.completed ? 'completed' : ''} flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border border-[var(--border)] rounded-lg gap-3">
            <div class="flex items-center gap-4 flex-grow"><input type="checkbox" class="task-checkbox h-5 w-5" data-id="${t.id}" ${t.completed ? 'checked' : ''}><div><p class="font-semibold text-lg">${t.name}</p><div class="flex items-center gap-3 mt-1"><span class="priority-badge priority-${t.priority}">${getPriorityText(t.priority)}</span><p class="text-sm text-[var(--text-secondary)]">${t.subject} | Vence: ${new Date(t.dueDate + 'T00:00:00').toLocaleDateString()}</p></div></div></div>
            <div class="flex gap-2 self-end sm:self-center"><button class="edit-task-btn p-2" data-id="${t.id}">‚úèÔ∏è</button><button class="delete-task-btn p-2" data-id="${t.id}">üóëÔ∏è</button></div></div>`).join('')}</div>`;
    }
    function renderCalendar() {
        const body = document.getElementById('calendar-body'), monthYearEl = document.getElementById('month-year');
        body.innerHTML = '';
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        monthYearEl.textContent = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) body.innerHTML += '<div></div>';
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = new Date(year, month, day).toDateString() === new Date().toDateString();
            let classes = `calendar-day text-center p-2 rounded-lg cursor-pointer hover:bg-[var(--accent)] ${state.events.some(e => e.date === dateStr) ? 'has-event' : ''} ${isToday ? 'bg-[var(--primary)] text-[var(--primary-foreground)] hover:!bg-[var(--primary)]' : ''}`;
            body.innerHTML += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
        }
    }
    function renderSubjects() {
        const c = document.getElementById('subjects-container');
        if(!state.subjects.length) { c.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-8">No hay asignaturas.</p>'; return; }
        c.innerHTML = state.subjects.map(s => {
            const avg = s.grades.length ? (s.grades.reduce((a, g) => a + g.score, 0) / s.grades.length).toFixed(2) : 'N/A';
            return `<div class="bg-[var(--card)] rounded-xl shadow-sm overflow-hidden border border-[var(--border)]"><div class="p-4 border-b flex justify-between items-center gap-3"><div><h4 class="text-xl font-bold">${s.name}</h4><p class="text-[var(--text-secondary)]">Promedio: <span class="font-semibold text-[var(--primary)]">${avg}</span></p></div><div class="flex gap-2"><button class="add-grade-btn bg-green-500 text-white text-sm font-bold py-1 px-3 rounded-full" data-subject-id="${s.id}">+ Nota</button><button class="delete-subject-btn text-[var(--danger)] text-sm font-bold py-1 px-3 rounded-full" data-subject-id="${s.id}">Eliminar</button></div></div><div class="p-4">${s.grades.length ? `<ul class="space-y-2">${s.grades.map(g => `<li class="flex justify-between"><span>${g.name}</span><b>${g.score}</b></li>`).join('')}</ul>` : '<p>No hay notas.</p>'}</div></div>`;
        }).join('');
    }
    function renderSocial() {
        document.getElementById('person-name-input').value = state.trackedPersonName;
        document.getElementById('tracked-person-name').textContent = state.trackedPersonName || '...';
        const logger = document.getElementById('person-feeling-logger');
        logger.style.cssText = state.trackedPersonName ? 'opacity:1; pointer-events:auto;' : 'opacity:0.5; pointer-events:none;';
        const history = document.getElementById('person-feelings-history');
        const sorted = [...state.personFeelings].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        history.innerHTML = sorted.length ? sorted.map(f => `<div class="p-3 bg-[var(--accent)] rounded-lg"><div class="flex justify-between"><p class="font-semibold">${f.feeling}</p><p class="text-sm">${new Date(f.timestamp).toLocaleDateString()}</p></div>${f.note ? `<p class="text-sm mt-1 italic">"${f.note}"</p>` : ''}</div>`).join('') : `<p class="text-center py-4">No hay registros.</p>`;
    }

    // Analysis Chart Renderer
    function renderCorrelationChart() {
        const ctx = document.getElementById('correlationChart').getContext('2d');
        if (correlationChartInstance) correlationChartInstance.destroy();

        const rootStyles = getComputedStyle(document.documentElement);
        const textColor = rootStyles.getPropertyValue('--text-primary').trim();

        // Date Range Logic
        const rangeButtons = document.querySelectorAll('#correlation-chart-ranges button');
        const selectedRange = document.querySelector('#correlation-chart-ranges button.active').dataset.range;
        const endDate = new Date();
        let startDate;
        if (selectedRange === 'all') {
            const allTimestamps = [
                ...state.emotions.map(e => new Date(e.timestamp)),
                ...state.personFeelings.map(f => new Date(f.timestamp)),
                ...state.subjects.flatMap(s => s.grades.map(g => new Date(g.timestamp)))
            ].filter(d => !isNaN(d));
            startDate = allTimestamps.length ? new Date(Math.min.apply(null, allTimestamps)) : dateFns.subDays(endDate, 30);
        } else {
            startDate = dateFns.subDays(endDate, parseInt(selectedRange));
        }

        // Filter data based on date range
        const filterByDate = (item) => dateFns.isWithinInterval(new Date(item.timestamp || item.date), { start: startDate, end: endDate });

        // Mappers
        const generalEmotionMap = { 'Triste': 1, 'Estresado': 2, 'Cansado': 3, 'Concentrado': 4, 'Feliz': 5 };
        const socialFeelingMap = { 'Triste': 1, 'Enojado': 2, 'Confundido': 3, 'Feliz': 4, 'Agradecido': 5, 'Amado': 6 };

        // Datasets
        const datasets = {
            general: {
                type: 'line', label: '√Ånimo General', data: state.emotions.filter(filterByDate).map(e => ({ x: new Date(e.timestamp), y: generalEmotionMap[e.emotion] })),
                borderColor: '#3B82F6', tension: 0.3, yAxisID: 'yEmotions',
            },
            social: {
                type: 'line', label: 'Sentimiento Social', data: state.personFeelings.filter(filterByDate).map(f => ({ x: new Date(f.timestamp), y: socialFeelingMap[f.feeling] })),
                borderColor: '#EC4899', tension: 0.3, yAxisID: 'yEmotions',
            },
            grades: {
                type: 'scatter', label: 'Calificaciones', data: state.subjects.flatMap(s => s.grades).filter(filterByDate).map(g => ({ x: new Date(g.timestamp), y: g.score, subject: g.subject, name: g.name })),
                backgroundColor: '#22C55E', radius: 6, hoverRadius: 8, yAxisID: 'yGrades',
            },
            events: {
                type: 'scatter', label: 'Eventos Clave', data: state.events.filter(e => dateFns.isWithinInterval(new Date(e.date), { start: startDate, end: endDate })).map(e => ({ x: new Date(e.date), y: 105, title: e.title, type: e.type })),
                pointStyle: (context) => {
                    if (!context.raw) return 'circle';
                    return context.raw.type === 'examen' ? 'star' : 'rect';
                },
                backgroundColor: '#F97316', radius: 8, hoverRadius: 10, yAxisID: 'yGrades',
            }
        };

        const visibleDatasets = [];
        document.querySelectorAll('#correlation-chart-toggles input:checked').forEach(cb => {
            visibleDatasets.push(datasets[cb.dataset.dataset]);
        });

        correlationChartInstance = new Chart(ctx, {
            data: { datasets: visibleDatasets },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd-MM-yyyy' }, ticks: { color: textColor }, min: startDate, max: endDate },
                    yEmotions: {
                        position: 'left', min: 0, max: 7, ticks: {
                            color: textColor, stepSize: 1,
                            callback: (v) => Object.keys(socialFeelingMap).find(k => socialFeelingMap[k] === v) || Object.keys(generalEmotionMap).find(k => generalEmotionMap[k] === v) || ''
                        }
                    },
                    yGrades: { position: 'right', min: 0, max: 110, ticks: { color: textColor }, grid: { drawOnChartArea: false } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dsLabel = context.dataset.label;
                                if (dsLabel === 'Calificaciones') {
                                    return `${dsLabel}: ${context.raw.y} (${context.raw.name})`;
                                }
                                if (dsLabel === 'Eventos Clave') {
                                    return `${context.raw.type}: ${context.raw.title}`;
                                }
                                return `${dsLabel}: ${context.formattedValue}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Modal Handlers
    function openTaskModal(taskId=null) {
        taskForm.reset(); document.getElementById('task-id').value = '';
        if (taskId) {
            const t = state.tasks.find(t => t.id === taskId);
            document.getElementById('task-modal-title').textContent = 'Editar Tarea';
            document.getElementById('task-id').value = t.id;
            document.getElementById('task-name').value = t.name;
            document.getElementById('task-subject').value = t.subject;
            document.getElementById('task-due-date').value = t.dueDate;
            document.getElementById('task-priority').value = t.priority;
        } else { document.getElementById('task-modal-title').textContent = 'A√±adir Tarea'; document.getElementById('task-priority').value = 3; }
        taskModal.classList.add('is-open');
    }
    function closeTaskModal() { taskModal.classList.remove('is-open'); }
    function openEventModal(date=null) { eventForm.reset(); if (date) document.getElementById('event-date').value = date; eventModal.classList.add('is-open'); }
    function closeEventModal() { eventModal.classList.remove('is-open'); }
    function openDayDetailsModal(date) {
        const events = state.events.filter(e => e.date === date);
        document.getElementById('day-details-title').textContent = new Date(date + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        document.getElementById('day-events-list').innerHTML = events.length ? events.map(e => `<div class="flex justify-between items-center p-3 bg-[var(--accent)] rounded-lg"><span>${e.title} (${e.type})</span><button class="delete-event-btn p-1 text-red-500" data-id="${e.id}">üóëÔ∏è</button></div>`).join('') : `<p>No hay eventos.</p>`;
        dayDetailsModal.classList.add('is-open');
    }
    function closeDayDetailsModal() { dayDetailsModal.classList.remove('is-open'); }

    // Event Listeners Setup
    function setupEventListeners() {
        // Nav
        document.getElementById('nav-menu').addEventListener('click', e => { const link = e.target.closest('a'); if (link?.dataset.section) { e.preventDefault(); showSection(link.dataset.section); if (window.innerWidth < 768) navMenu.classList.add('hidden'); } });
        document.getElementById('mobile-menu-button').addEventListener('click', () => navMenu.classList.toggle('hidden'));

        // Task Modal
        document.getElementById('add-task-btn').addEventListener('click', () => openTaskModal());
        document.getElementById('cancel-task-btn').addEventListener('click', closeTaskModal);
        taskForm.addEventListener('submit', e => { e.preventDefault(); const id = document.getElementById('task-id').value; const data = { name: document.getElementById('task-name').value, subject: document.getElementById('task-subject').value, dueDate: document.getElementById('task-due-date').value, priority: parseInt(document.getElementById('task-priority').value) }; if (id) { const i = state.tasks.findIndex(t => t.id == id); state.tasks[i] = { ...state.tasks[i], ...data }; } else { state.tasks.push({ id: Date.now(), completed: false, ...data }); } saveState(); closeTaskModal(); renderAll(); });
        document.getElementById('task-list').addEventListener('click', e => { const t = e.target; if (t.matches('.task-checkbox')) { state.tasks.find(task => task.id === parseInt(t.dataset.id)).completed = t.checked; saveState(); renderTasks(); renderDashboard(); } else { const btn = t.closest('button'); if (btn?.matches('.edit-task-btn')) openTaskModal(parseInt(btn.dataset.id)); else if (btn?.matches('.delete-task-btn')) { state.tasks = state.tasks.filter(task => task.id !== parseInt(btn.dataset.id)); saveState(); renderAll(); } } });

        // Calendar & Event Modal
        document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        document.getElementById('add-event-btn').addEventListener('click', () => openEventModal());
        document.getElementById('cancel-event-btn').addEventListener('click', closeEventModal);
        document.getElementById('close-day-details-btn').addEventListener('click', closeDayDetailsModal);
        document.getElementById('calendar-body').addEventListener('click', e => { if (e.target.matches('.calendar-day')) { const d = e.target.dataset.date; if (state.events.some(ev => ev.date === d)) openDayDetailsModal(d); else openEventModal(d); } });
        document.getElementById('day-events-list').addEventListener('click', e => { const b = e.target.closest('.delete-event-btn'); if (b) { state.events = state.events.filter(ev => ev.id !== parseInt(b.dataset.id)); saveState(); closeDayDetailsModal(); renderAll(); } });
        eventForm.addEventListener('submit', e => { e.preventDefault(); state.events.push({ id: Date.now(), title: document.getElementById('event-title').value, date: document.getElementById('event-date').value, type: document.getElementById('event-type').value }); saveState(); closeEventModal(); renderAll(); });

        // Subjects
        document.getElementById('add-subject-btn').addEventListener('click', () => { const n = prompt('Nombre de la asignatura:'); if (n) { state.subjects.push({ id: Date.now(), name: n, grades: [] }); saveState(); renderAll(); } });
        document.getElementById('subjects-container').addEventListener('click', e => {
            const addBtn = e.target.closest('.add-grade-btn'), delBtn = e.target.closest('.delete-subject-btn');
            if (addBtn) {
                const sId = parseInt(addBtn.dataset.subjectId);
                const name = prompt('Descripci√≥n de la calificaci√≥n:'), scoreStr = prompt('Calificaci√≥n (0-100):');
                if (name && scoreStr) { const score = parseFloat(scoreStr); if (!isNaN(score) && score >= 0 && score <= 100) { state.subjects.find(s => s.id === sId).grades.push({ id: Date.now(), name, score, timestamp: new Date().toISOString() }); saveState(); renderAll(); if(!document.getElementById('analisis').classList.contains('hidden')) renderCorrelationChart(); } else alert('Calificaci√≥n no v√°lida.'); }
            } else if (delBtn) { if (confirm('¬øEliminar esta asignatura?')) { state.subjects = state.subjects.filter(s => s.id !== parseInt(delBtn.dataset.subjectId)); saveState(); renderAll(); if(!document.getElementById('analisis').classList.contains('hidden')) renderCorrelationChart(); } }
        });

        // Emotions & Social
        document.querySelectorAll('.theme-btn').forEach(btn => btn.addEventListener('click', () => applyTheme(btn.dataset.theme)));
        document.getElementById('emotion-tracker').addEventListener('click', e => { if (e.target.matches('.emotion-btn')) { document.querySelectorAll('#emotion-tracker .emotion-btn').forEach(b => b.classList.remove('selected')); e.target.classList.add('selected'); selectedGeneralEmotion = e.target.dataset.emotion; } });
        document.getElementById('save-emotion-btn').addEventListener('click', () => { if (!selectedGeneralEmotion) return alert('Selecciona una emoci√≥n.'); state.emotions.push({ id: Date.now(), emotion: selectedGeneralEmotion, note: document.getElementById('emotion-note').value, timestamp: new Date().toISOString() }); saveState(); document.querySelectorAll('#emotion-tracker .emotion-btn').forEach(b => b.classList.remove('selected')); document.getElementById('emotion-note').value = ''; selectedGeneralEmotion = null; alert('¬°Emoci√≥n registrada!'); if(!document.getElementById('analisis').classList.contains('hidden')) renderCorrelationChart(); });
        document.getElementById('save-person-name-btn').addEventListener('click', () => { state.trackedPersonName = document.getElementById('person-name-input').value; saveState(); renderSocial(); if(!document.getElementById('analisis').classList.contains('hidden')) renderCorrelationChart(); });
        document.getElementById('person-emotion-tracker').addEventListener('click', e => { if (e.target.matches('.emotion-btn')) { document.querySelectorAll('#person-emotion-tracker .emotion-btn').forEach(b => b.classList.remove('selected')); e.target.classList.add('selected'); selectedPersonEmotion = e.target.dataset.emotion; } });
        document.getElementById('save-person-emotion-btn').addEventListener('click', () => { if (!selectedPersonEmotion) return alert('Selecciona un sentimiento.'); state.personFeelings.push({ id: Date.now(), feeling: selectedPersonEmotion, note: document.getElementById('person-emotion-note').value, timestamp: new Date().toISOString() }); saveState(); document.querySelectorAll('#person-emotion-tracker .emotion-btn').forEach(b => b.classList.remove('selected')); document.getElementById('person-emotion-note').value = ''; selectedPersonEmotion = null; alert('¬°Sentimiento registrado!'); renderSocial(); if(!document.getElementById('analisis').classList.contains('hidden')) renderCorrelationChart(); });

        // Analysis Chart Controls
        document.getElementById('correlation-chart-toggles').addEventListener('change', renderCorrelationChart);
        document.getElementById('correlation-chart-ranges').addEventListener('click', e => {
            if (e.target.matches('button')) {
                document.querySelectorAll('#correlation-chart-ranges button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                renderCorrelationChart();
            }
        });
    }

    // Initial Load
    const savedTheme = localStorage.getItem('studyHubTheme') || 'light';
    applyTheme(savedTheme);
    setupEventListeners();
    renderAll();
});
</script>
</body>
</html>
